name: Full CI + SonarQube + SAST + Dependency Security

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    # --------------------------------------------------------
    # 1. CHECKOUT
    # --------------------------------------------------------
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0     # Required for SonarQube PR decoration & blame

    # --------------------------------------------------------
    # 2. PYTHON SETUP
    # --------------------------------------------------------
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"

    - name: Install Dependencies
      run: |
        pip install -r requirements.txt
        pip install pytest coverage bandit pip-audit safety

    # --------------------------------------------------------
    # 3. UNIT TESTS + COVERAGE
    # --------------------------------------------------------
    - name: Run Tests + Coverage
      run: |
        coverage run -m pytest
        coverage xml

    # --------------------------------------------------------
    # 4. SAST (Secure Static Analysis)
    # --------------------------------------------------------
    - name: Bandit SAST Scan
      run: |
        bandit -r . -f json -o bandit-report.json
      continue-on-error: true

    # --------------------------------------------------------
    # 5. DEPENDENCY VULNERABILITY SCANNING
    # --------------------------------------------------------
    - name: pip-audit
      run: |
        pip-audit --format json --output pip-audit.json
      continue-on-error: true

    - name: Safety Scan
      run: |
        safety check --json > safety-report.json
      continue-on-error: true

    - name: Trivy Filesystem Scan
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: fs
        ignore-unfixed: true
        format: json
        output: trivy-fs.json
      continue-on-error: true

    # --------------------------------------------------------
    # 6. SONARQUBE SCAN (FULL FEATURES)
    # --------------------------------------------------------
    - name: SonarQube Scan
      uses: sonarsource/sonarqube-scan-action@master
      env:
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}

    # --------------------------------------------------------
    # 7. QUALITY GATE ENFORCEMENT (BLOCK PIPELINE IF FAILED)
    # --------------------------------------------------------
    - name: SonarQube Quality Gate Check
      uses: sonarsource/sonarqube-quality-gate-action@master
      timeout-minutes: 5
      env:
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

    # --------------------------------------------------------
    # 8. UPLOAD SECURITY ARTIFACTS
    # --------------------------------------------------------
    - name: Upload Security Reports
      uses: actions/upload-artifact@v3
      with:
        name: security-reports
        path: |
          bandit-report.json
          pip-audit.json
          safety-report.json
          trivy-fs.json
          coverage.xml
